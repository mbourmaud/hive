#!/bin/bash
# Check my tasks (for Workers)

set -e

if [ -z "$AGENT_ID" ]; then
    echo "âŒ Error: AGENT_ID not set (are you running in a worker container?)"
    exit 1
fi

echo "ðŸ Tasks for $AGENT_ID"
echo ""

# Check active task
echo "âš¡ Active Task:"
ACTIVE=$(redis-cli -h ${REDIS_HOST:-hive-redis} -p ${REDIS_PORT:-6379} LINDEX "hive:active:$AGENT_ID" 0 2>/dev/null)

if [ -n "$ACTIVE" ] && [ "$ACTIVE" != "(nil)" ]; then
    TITLE=$(echo "$ACTIVE" | jq -r '.title // "Untitled"')
    DESCRIPTION=$(echo "$ACTIVE" | jq -r '.description // ""')
    BRANCH=$(echo "$ACTIVE" | jq -r '.branch // ""')
    JIRA=$(echo "$ACTIVE" | jq -r '.jira_ticket // ""')

    echo "  ðŸ“‹ $TITLE"
    [ -n "$DESCRIPTION" ] && echo "     $DESCRIPTION"
    [ -n "$JIRA" ] && echo "     Jira: $JIRA"
    [ -n "$BRANCH" ] && echo "     Branch: $BRANCH"
else
    echo "  None"
fi

echo ""

# Check queue
echo "ðŸ“¥ Queued Tasks:"
QUEUE_COUNT=$(redis-cli -h ${REDIS_HOST:-hive-redis} -p ${REDIS_PORT:-6379} LLEN "hive:queue:$AGENT_ID" 2>/dev/null)

if [ "$QUEUE_COUNT" -gt 0 ]; then
    echo "  $QUEUE_COUNT task(s) waiting"

    # Show first task in queue
    NEXT=$(redis-cli -h ${REDIS_HOST:-hive-redis} -p ${REDIS_PORT:-6379} LINDEX "hive:queue:$AGENT_ID" 0 2>/dev/null)
    if [ -n "$NEXT" ] && [ "$NEXT" != "(nil)" ]; then
        NEXT_TITLE=$(echo "$NEXT" | jq -r '.title // "Untitled"')
        echo "  Next: $NEXT_TITLE"
    fi
else
    echo "  None"
fi

echo ""

if [ "$QUEUE_COUNT" -gt 0 ] && [ -z "$ACTIVE" ] || [ "$ACTIVE" = "(nil)" ]; then
    echo "ðŸ’¡ Tip: Run 'take-task' to start working on the next task"
fi
