#!/bin/bash
# Take next task from queue (for Workers)

set -e

if [ -z "$AGENT_ID" ]; then
    echo "âŒ Error: AGENT_ID not set"
    exit 1
fi

# Check if there's already an active task
ACTIVE=$(redis-cli -h localhost -p 6380 LINDEX "hive:active:$AGENT_ID" 0 2>/dev/null)
if [ -n "$ACTIVE" ] && [ "$ACTIVE" != "(nil)" ]; then
    echo "âŒ You already have an active task!"
    echo ""
    TITLE=$(echo "$ACTIVE" | jq -r '.title // "Untitled"')
    echo "Active: $TITLE"
    echo ""
    echo "Finish it first with 'task-done' or 'task-failed'"
    exit 1
fi

# Find the dequeue script
DEQUEUE_SCRIPT="/scripts/redis/task-dequeue.sh"
if [ ! -f "$DEQUEUE_SCRIPT" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    DEQUEUE_SCRIPT="${SCRIPT_DIR}/../redis/task-dequeue.sh"
fi

# Dequeue task
TASK=$("$DEQUEUE_SCRIPT" "$AGENT_ID" 2>/dev/null)

if [ -z "$TASK" ] || [ "$TASK" = "(nil)" ] || echo "$TASK" | grep -q "No tasks in queue"; then
    echo "ðŸ“­ No tasks in queue for $AGENT_ID"
    exit 0
fi

# Parse and display task
TITLE=$(echo "$TASK" | jq -r '.title // "Untitled"')
DESCRIPTION=$(echo "$TASK" | jq -r '.description // ""')
BRANCH=$(echo "$TASK" | jq -r '.branch // ""')
JIRA=$(echo "$TASK" | jq -r '.jira_ticket // ""')

echo "ðŸ“¥ Task received!"
echo ""
echo "ðŸ“‹ $TITLE"
[ -n "$DESCRIPTION" ] && echo "   $DESCRIPTION"
echo ""
[ -n "$JIRA" ] && echo "ðŸŽ« Jira: $JIRA"
[ -n "$BRANCH" ] && echo "ðŸŒ¿ Branch: $BRANCH"
echo ""
echo "ðŸ’¡ When done:"
echo "   - Success: task-done"
echo "   - Failed: task-failed \"error message\""
