#!/bin/bash
# Check my tasks (for Workers)

set -e

# Support both AGENT_ID and AGENT_NAME
AGENT_ID="${AGENT_ID:-$AGENT_NAME}"
if [ -z "$AGENT_ID" ]; then
    echo "‚ùå Error: AGENT_ID/AGENT_NAME not set (are you running in a worker container?)"
    exit 1
fi

# Redis connection with auth
REDIS_HOST="${REDIS_HOST:-redis}"
REDIS_PORT="${REDIS_PORT:-6379}"
REDIS_AUTH=""
if [ -n "$REDIS_PASSWORD" ]; then
    REDIS_AUTH="-a $REDIS_PASSWORD"
fi
rcli() {
    redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" $REDIS_AUTH "$@" 2>/dev/null
}

echo "üêù Tasks for $AGENT_ID"
echo ""

# Check active task
echo "‚ö° Active Task:"
ACTIVE=$(rcli LINDEX "hive:active:$AGENT_ID" 0)

if [ -n "$ACTIVE" ] && [ "$ACTIVE" != "(nil)" ]; then
    TITLE=$(echo "$ACTIVE" | jq -r '.title // "Untitled"')
    DESCRIPTION=$(echo "$ACTIVE" | jq -r '.description // ""')
    BRANCH=$(echo "$ACTIVE" | jq -r '.branch // ""')
    JIRA=$(echo "$ACTIVE" | jq -r '.jira_ticket // ""')

    echo "  üìã $TITLE"
    [ -n "$DESCRIPTION" ] && echo "     $DESCRIPTION"
    [ -n "$JIRA" ] && echo "     Jira: $JIRA"
    [ -n "$BRANCH" ] && echo "     Branch: $BRANCH"
else
    echo "  None"
fi

echo ""

# Check queue
echo "üì• Queued Tasks:"
QUEUE_COUNT=$(rcli LLEN "hive:queue:$AGENT_ID")

if [ "$QUEUE_COUNT" -gt 0 ]; then
    echo "  $QUEUE_COUNT task(s) waiting"

    # Show first task in queue
    NEXT=$(rcli LINDEX "hive:queue:$AGENT_ID" 0)
    if [ -n "$NEXT" ] && [ "$NEXT" != "(nil)" ]; then
        NEXT_TITLE=$(echo "$NEXT" | jq -r '.title // "Untitled"')
        echo "  Next: $NEXT_TITLE"
    fi
else
    echo "  None"
fi

echo ""

if [ "$QUEUE_COUNT" -gt 0 ] && [ -z "$ACTIVE" ] || [ "$ACTIVE" = "(nil)" ]; then
    echo "üí° Tip: Run 'take-task' to start working on the next task"
fi
