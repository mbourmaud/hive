#!/bin/bash
# Mark active task as completed (for Workers)

set -e

if [ -z "$AGENT_ID" ]; then
    echo "‚ùå Error: AGENT_ID not set"
    exit 1
fi

# Check if there's an active task
ACTIVE=$(redis-cli -h ${REDIS_HOST:-hive-redis} -p ${REDIS_PORT:-6379} LINDEX "hive:active:$AGENT_ID" 0 2>/dev/null)
if [ -z "$ACTIVE" ] || [ "$ACTIVE" = "(nil)" ]; then
    echo "‚ùå No active task to complete"
    exit 1
fi

TITLE=$(echo "$ACTIVE" | jq -r '.title // "Untitled"')

# Optional result parameter
RESULT="${1:-{}}"

# Find the complete script
COMPLETE_SCRIPT="/scripts/redis/task-complete.sh"
if [ ! -f "$COMPLETE_SCRIPT" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    COMPLETE_SCRIPT="${SCRIPT_DIR}/../redis/task-complete.sh"
fi

"$COMPLETE_SCRIPT" "$AGENT_ID" "$RESULT"

echo ""
echo "Task completed: $TITLE"
echo ""
echo "üí° Check for more work: my-tasks"
