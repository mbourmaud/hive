# Claude Code Agent Container
# Generic multi-agent worker with Claude Code and common dev tools

FROM node:22-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    tmux \
    jq \
    netcat-openbsd \
    openssh-client \
    ca-certificates \
    gnupg \
    unzip \
    python3 \
    python3-pip \
    redis-tools \
    expect \
    && rm -rf /var/lib/apt/lists/*

# Docker CLI (for testcontainers) - using static binary
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "arm64" ]; then ARCH="aarch64"; else ARCH="x86_64"; fi && \
    wget "https://download.docker.com/linux/static/stable/${ARCH}/docker-27.4.1.tgz" \
        -O /tmp/docker.tgz \
    && tar -xzf /tmp/docker.tgz -C /tmp \
    && mv /tmp/docker/docker /usr/local/bin/docker \
    && chmod +x /usr/local/bin/docker \
    && rm -rf /tmp/docker*

# Node-based CLI tools
# Set pnpm environment (aligned with volume mount path)
ENV PNPM_HOME="/home/agent/.local/share/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

# Install with BuildKit cache mount for faster rebuilds
RUN --mount=type=cache,id=pnpm,target=/pnpm/store \
    npm install -g \
    @anthropic-ai/claude-code \
    pnpm@10.17.0

# GitHub CLI (gh)
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "arm64" ]; then ARCH="arm64"; else ARCH="amd64"; fi && \
    wget "https://github.com/cli/cli/releases/download/v2.40.0/gh_2.40.0_linux_${ARCH}.deb" \
        -O /tmp/gh.deb \
    && dpkg -i /tmp/gh.deb \
    && rm /tmp/gh.deb

# GitLab CLI (glab) - optional
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "arm64" ]; then ARCH="arm64"; else ARCH="amd64"; fi && \
    wget "https://gitlab.com/gitlab-org/cli/-/releases/v1.46.1/downloads/glab_1.46.1_Linux_${ARCH}.deb" \
        -O /tmp/glab.deb \
    && dpkg -i /tmp/glab.deb \
    && rm /tmp/glab.deb

# yq (YAML processor)
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "arm64" ]; then ARCH="arm64"; else ARCH="amd64"; fi && \
    wget "https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_${ARCH}" \
        -O /usr/local/bin/yq \
    && chmod +x /usr/local/bin/yq

# Playwright (for browser automation)
ENV PLAYWRIGHT_BROWSERS_PATH=/opt/playwright
RUN npm install -g @playwright/mcp@latest \
    && npx -y playwright install chromium --with-deps \
    && chmod -R 755 /opt/playwright

# Create non-root user
RUN useradd -m -s /bin/bash agent

# Switch to agent user
USER agent
WORKDIR /home/agent

# Git global config
RUN git config --global --add safe.directory '*' \
    && git config --global init.defaultBranch main

# Create necessary directories
RUN mkdir -p ~/.config ~/.aws ~/.ssh ~/.claude/debug ~/.claude/todos ~/.claude/statsig ~/.claude/projects \
    && mkdir -p ~/.local/share/pnpm/.tools ~/.local/share/pnpm/state ~/.local/share/pnpm/store

# Copy entrypoint and scripts
COPY --chown=agent:agent entrypoint.sh /home/agent/entrypoint.sh
COPY --chown=agent:agent start-worker.sh /home/agent/start-worker.sh
COPY --chown=agent:agent worker-daemon.py /home/agent/worker-daemon.py
COPY --chown=agent:agent tools.py /home/agent/tools.py
COPY --chown=agent:agent templates/.claude.json.template /home/agent/.claude.json.template
RUN chmod +x /home/agent/entrypoint.sh /home/agent/start-worker.sh /home/agent/worker-daemon.py

# Copy Redis task management scripts
COPY --chown=agent:agent scripts/redis/*.sh /scripts/redis/
RUN chmod +x /scripts/redis/*.sh

# Copy HIVE CLI commands (available in PATH)
COPY --chown=agent:agent scripts/bin/* /usr/local/bin/
RUN chmod +x /usr/local/bin/hive-assign /usr/local/bin/hive-failed /usr/local/bin/hive-status \
    /usr/local/bin/my-tasks /usr/local/bin/take-task /usr/local/bin/task-done /usr/local/bin/task-failed

ENTRYPOINT ["/home/agent/entrypoint.sh"]
CMD ["bash"]
