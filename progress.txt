# Ralph Progress Log
# Project: Hive-lite: Multi-Ralph Orchestration via Bash
# Location: /Users/fr162241/Projects/hive
# Started: Thu Jan 15 18:15:09 CET 2026
#
# This file is generated and maintained by Ralph.
# See: https://github.com/thecgaigroup/ralph-cc-loop
---

## Codebase Patterns
- Use jq for all JSON manipulation in bash scripts
- Store script at scripts/hive.sh
- Config file at .hive/config.json
- Worktrees at .hive/worktrees/<name>/
- Use ANSI colors for terminal output (RED, GREEN, YELLOW, BLUE, CYAN, NC for reset)
- All timestamps in ISO 8601 format
- Git worktrees cannot have multiple checkouts of the same branch - detect with `git worktree list --porcelain` and awk
- Multiple Ralphs on same branch share one worktree, differentiated by scope
- Use `jq --arg` with `|| true` instead of `jq -e` when checking for entry existence (avoids `set -e` exit on no match)
- Use nohup for background processes to survive terminal close
- Check process liveness with `kill -0 $pid`

---

## [Iteration 1] 2026-01-15T17:20:00Z - US-001
- **What was implemented:** Initialize Hive directory structure
- **Files changed:**
  - scripts/hive.sh (new) - Main hive script with init command
  - prd.json (updated) - Marked US-001 as passes: true
- **Learnings for future iterations:**
  - The script uses `set -e` for fail-fast behavior
  - Helper functions: print_info, print_success, print_warning, print_error for consistent colored output
  - check_git_repo() verifies we're in a git repository before operations
  - check_dependencies() ensures jq is installed
  - Config validation uses jq -e to check for required fields
  - Idempotency achieved by checking existence before creating files/directories
---

## [Iteration 2] 2026-01-15T17:21:00Z - US-002
- **What was implemented:** Spawn Ralph with branch creation (--create)
- **Files changed:**
  - scripts/hive.sh (modified) - Added cmd_spawn(), show_spawn_usage(), spawn_with_create(), spawn_with_attach() (placeholder)
  - prd.json (updated) - Marked US-002 as passes: true
- **Implementation details:**
  - Command: `hive.sh spawn <name> --create <branch> [--from <base>]`
  - Argument parsing uses while loop with case statement for --create, --attach, --from, --scope flags
  - Validates: ralph name exists, branch doesn't exist (local or remote), hive is initialized
  - Creates worktree using `git worktree add -b <branch> <path> <base_ref>`
  - Updates config.json with ralph entry containing branchMode:'created', baseBranch, targetBranch
  - Updates config.json branches section with branch metadata and ralphs array
  - Uses `mktemp` for safe JSON file updates
- **Learnings for future iterations:**
  - Use `git show-ref --verify --quiet "refs/heads/$branch"` to check if local branch exists
  - Use `git show-ref --verify --quiet "refs/remotes/origin/$branch"` to check if remote branch exists
  - The spawn_with_attach() is a placeholder for US-003
  - Config structure for a ralph: {name, branch, branchMode, baseBranch, targetBranch, scope, worktreePath, status, pid, pr, createdAt, startedAt}
  - Config structure for a branch: {baseBranch, createdBy, createdAt, ralphs:[]}
---

## [Iteration 3] 2026-01-15T17:26:00Z - US-003
- **What was implemented:** Spawn Ralph with branch attachment (--attach)
- **Files changed:**
  - scripts/hive.sh (modified) - Implemented spawn_with_attach() function
  - prd.json (updated) - Marked US-003 as passes: true
- **Implementation details:**
  - Command: `hive.sh spawn <name> --attach <branch> [--scope <glob>]`
  - Checks if branch exists locally or on remote (errors if neither)
  - Detects if branch is already checked out in another worktree using `git worktree list --porcelain` and awk
  - If branch already in use, shares existing worktree instead of failing
  - Creates worktree using `git worktree add <path> <branch>` for local branches
  - Creates worktree using `git worktree add --track -b <branch> <path> origin/<branch>` for remote-only branches
  - Updates config.json with branchMode:'attached'
  - For new branches, creates branch entry with createdBy:'external'
  - For existing branch entries, appends ralph to ralphs array and dedupes with `unique`
  - Shows warning when multiple Ralphs attach to same branch
- **Learnings for future iterations:**
  - Git worktrees cannot have multiple checkouts of the same branch
  - To detect existing worktree for a branch: `git worktree list --porcelain | awk -v branch="refs/heads/$branch" '/^worktree / { wt = substr($0, 10) } /^branch / { if (substr($0, 8) == branch) print wt }'`
  - Multiple Ralphs sharing a branch should use different worktree paths in config but point to the same actual worktree
  - Scope restrictions are recorded in config.json and will be passed to Ralph's prompt in US-004
---

## [Iteration 4] 2026-01-15T17:30:00Z - US-004
- **What was implemented:** Start Ralph background process
- **Files changed:**
  - scripts/hive.sh (modified) - Added cmd_start(), show_start_usage()
  - prd.json (updated) - Marked US-004 as passes: true
- **Implementation details:**
  - Command: `hive.sh start <name> [prompt]`
  - Validates ralph exists and is not already running (checks PID liveness)
  - Validates worktree directory exists
  - Checks claude CLI is available in PATH
  - Builds prompt: uses custom prompt if provided, otherwise default autonomous work prompt
  - Adds scope restriction to prompt if --scope was set during spawn
  - Creates ralph-output.log with header (ralph name, branch, timestamp, scope)
  - Launches `claude --dangerously-skip-permissions -p <prompt>` in background using nohup
  - Captures PID via temp file written in subshell
  - Updates config.json: pid, status='running', startedAt timestamp
  - Handles edge case: process was marked running but PID is dead
- **Learnings for future iterations:**
  - Use `jq --arg` instead of `jq -e --arg` when checking if entry exists, combined with `|| true` to avoid `set -e` exiting on no match
  - Use nohup to keep process running after terminal closes
  - Capture PID by writing to temp file in subshell, then reading it
  - Use `kill -0 $pid` to check if process is running (doesn't send signal, just checks)
  - Log file location: `$worktree_path/ralph-output.log`
---

## [Iteration 5] 2026-01-15T17:35:00Z - US-005
- **What was implemented:** Show Hive status dashboard
- **Files changed:**
  - scripts/hive.sh (modified) - Added cmd_status(), show_status_usage()
  - prd.json (updated) - Marked US-005 as passes: true
- **Implementation details:**
  - Command: `hive.sh status`
  - Shows formatted dashboard with ANSI colors and box-drawing characters
  - Displays each Ralph with: name, status (color-coded), branch (mode), target branch, scope, worktree path, PID (if running), started timestamp, PR status (if exists)
  - Verifies PID liveness for "running" Ralphs using `kill -0 $pid` - automatically updates status to "stopped" if process is dead
  - Shows "(process died)" indicator when a process was marked running but PID is no longer alive
  - Uses `gh pr view` to fetch current PR state, CI check status, and review status from GitHub
  - Shows last line of log file (filtered for non-header content) as activity indicator for running Ralphs
  - Branch relationships section shows all branches with their attached Ralphs
  - Warns when multiple Ralphs share a branch (with ⚠ indicator)
  - Summary line shows totals: total count, running count, idle count, PRs count
  - Color scheme: green=running/completed/approved, yellow=spawned/stopped/pending, red=failed/closed
- **Learnings for future iterations:**
  - Use `jq --argjson i "$i"` to iterate by index through JSON arrays
  - PR status fetching with `gh pr view` is graceful - errors are suppressed with `|| echo ""`
  - `grep -v` chains work well to filter out header lines from log files
  - Status symbol mapping: ● for active, ✓ for completed, ○ for idle, ✗ for failed
---
