# Ralph Progress Log
# Project: Hive-lite: Multi-Ralph Orchestration via Bash
# Location: /Users/fr162241/Projects/hive
# Started: Thu Jan 15 18:15:09 CET 2026
#
# This file is generated and maintained by Ralph.
# See: https://github.com/thecgaigroup/ralph-cc-loop
---

## Codebase Patterns
- Use jq for all JSON manipulation in bash scripts
- Store script at scripts/hive.sh
- Config file at .hive/config.json
- Worktrees at .hive/worktrees/<name>/
- Use ANSI colors for terminal output (RED, GREEN, YELLOW, BLUE, CYAN, NC for reset)
- All timestamps in ISO 8601 format
- Git worktrees cannot have multiple checkouts of the same branch - detect with `git worktree list --porcelain` and awk
- Multiple Ralphs on same branch share one worktree, differentiated by scope
- Use `jq --arg` with `|| true` instead of `jq -e` when checking for entry existence (avoids `set -e` exit on no match)
- Use nohup for background processes to survive terminal close
- Check process liveness with `kill -0 $pid`
- Use `kill -STOP $pid` and `kill -CONT $pid` to pause/resume processes without terminating
- For bash 3.2 compatibility (macOS), use `tr '[:lower:]' '[:upper:]'` instead of ${var^^} for uppercase conversion

---

## [Iteration 1] 2026-01-15T17:20:00Z - US-001
- **What was implemented:** Initialize Hive directory structure
- **Files changed:**
  - scripts/hive.sh (new) - Main hive script with init command
  - prd.json (updated) - Marked US-001 as passes: true
- **Learnings for future iterations:**
  - The script uses `set -e` for fail-fast behavior
  - Helper functions: print_info, print_success, print_warning, print_error for consistent colored output
  - check_git_repo() verifies we're in a git repository before operations
  - check_dependencies() ensures jq is installed
  - Config validation uses jq -e to check for required fields
  - Idempotency achieved by checking existence before creating files/directories
---

## [Iteration 2] 2026-01-15T17:21:00Z - US-002
- **What was implemented:** Spawn Ralph with branch creation (--create)
- **Files changed:**
  - scripts/hive.sh (modified) - Added cmd_spawn(), show_spawn_usage(), spawn_with_create(), spawn_with_attach() (placeholder)
  - prd.json (updated) - Marked US-002 as passes: true
- **Implementation details:**
  - Command: `hive.sh spawn <name> --create <branch> [--from <base>]`
  - Argument parsing uses while loop with case statement for --create, --attach, --from, --scope flags
  - Validates: ralph name exists, branch doesn't exist (local or remote), hive is initialized
  - Creates worktree using `git worktree add -b <branch> <path> <base_ref>`
  - Updates config.json with ralph entry containing branchMode:'created', baseBranch, targetBranch
  - Updates config.json branches section with branch metadata and ralphs array
  - Uses `mktemp` for safe JSON file updates
- **Learnings for future iterations:**
  - Use `git show-ref --verify --quiet "refs/heads/$branch"` to check if local branch exists
  - Use `git show-ref --verify --quiet "refs/remotes/origin/$branch"` to check if remote branch exists
  - The spawn_with_attach() is a placeholder for US-003
  - Config structure for a ralph: {name, branch, branchMode, baseBranch, targetBranch, scope, worktreePath, status, pid, pr, createdAt, startedAt}
  - Config structure for a branch: {baseBranch, createdBy, createdAt, ralphs:[]}
---

## [Iteration 3] 2026-01-15T17:26:00Z - US-003
- **What was implemented:** Spawn Ralph with branch attachment (--attach)
- **Files changed:**
  - scripts/hive.sh (modified) - Implemented spawn_with_attach() function
  - prd.json (updated) - Marked US-003 as passes: true
- **Implementation details:**
  - Command: `hive.sh spawn <name> --attach <branch> [--scope <glob>]`
  - Checks if branch exists locally or on remote (errors if neither)
  - Detects if branch is already checked out in another worktree using `git worktree list --porcelain` and awk
  - If branch already in use, shares existing worktree instead of failing
  - Creates worktree using `git worktree add <path> <branch>` for local branches
  - Creates worktree using `git worktree add --track -b <branch> <path> origin/<branch>` for remote-only branches
  - Updates config.json with branchMode:'attached'
  - For new branches, creates branch entry with createdBy:'external'
  - For existing branch entries, appends ralph to ralphs array and dedupes with `unique`
  - Shows warning when multiple Ralphs attach to same branch
- **Learnings for future iterations:**
  - Git worktrees cannot have multiple checkouts of the same branch
  - To detect existing worktree for a branch: `git worktree list --porcelain | awk -v branch="refs/heads/$branch" '/^worktree / { wt = substr($0, 10) } /^branch / { if (substr($0, 8) == branch) print wt }'`
  - Multiple Ralphs sharing a branch should use different worktree paths in config but point to the same actual worktree
  - Scope restrictions are recorded in config.json and will be passed to Ralph's prompt in US-004
---

## [Iteration 4] 2026-01-15T17:30:00Z - US-004
- **What was implemented:** Start Ralph background process
- **Files changed:**
  - scripts/hive.sh (modified) - Added cmd_start(), show_start_usage()
  - prd.json (updated) - Marked US-004 as passes: true
- **Implementation details:**
  - Command: `hive.sh start <name> [prompt]`
  - Validates ralph exists and is not already running (checks PID liveness)
  - Validates worktree directory exists
  - Checks claude CLI is available in PATH
  - Builds prompt: uses custom prompt if provided, otherwise default autonomous work prompt
  - Adds scope restriction to prompt if --scope was set during spawn
  - Creates ralph-output.log with header (ralph name, branch, timestamp, scope)
  - Launches `claude --dangerously-skip-permissions -p <prompt>` in background using nohup
  - Captures PID via temp file written in subshell
  - Updates config.json: pid, status='running', startedAt timestamp
  - Handles edge case: process was marked running but PID is dead
- **Learnings for future iterations:**
  - Use `jq --arg` instead of `jq -e --arg` when checking if entry exists, combined with `|| true` to avoid `set -e` exiting on no match
  - Use nohup to keep process running after terminal closes
  - Capture PID by writing to temp file in subshell, then reading it
  - Use `kill -0 $pid` to check if process is running (doesn't send signal, just checks)
  - Log file location: `$worktree_path/ralph-output.log`
---

## [Iteration 5] 2026-01-15T17:35:00Z - US-005
- **What was implemented:** Show Hive status dashboard
- **Files changed:**
  - scripts/hive.sh (modified) - Added cmd_status(), show_status_usage()
  - prd.json (updated) - Marked US-005 as passes: true
- **Implementation details:**
  - Command: `hive.sh status`
  - Shows formatted dashboard with ANSI colors and box-drawing characters
  - Displays each Ralph with: name, status (color-coded), branch (mode), target branch, scope, worktree path, PID (if running), started timestamp, PR status (if exists)
  - Verifies PID liveness for "running" Ralphs using `kill -0 $pid` - automatically updates status to "stopped" if process is dead
  - Shows "(process died)" indicator when a process was marked running but PID is no longer alive
  - Uses `gh pr view` to fetch current PR state, CI check status, and review status from GitHub
  - Shows last line of log file (filtered for non-header content) as activity indicator for running Ralphs
  - Branch relationships section shows all branches with their attached Ralphs
  - Warns when multiple Ralphs share a branch (with ⚠ indicator)
  - Summary line shows totals: total count, running count, idle count, PRs count
  - Color scheme: green=running/completed/approved, yellow=spawned/stopped/pending, red=failed/closed
- **Learnings for future iterations:**
  - Use `jq --argjson i "$i"` to iterate by index through JSON arrays
  - PR status fetching with `gh pr view` is graceful - errors are suppressed with `|| echo ""`
  - `grep -v` chains work well to filter out header lines from log files
  - Status symbol mapping: ● for active, ✓ for completed, ○ for idle, ✗ for failed
---

## [Iteration 6] 2026-01-15T18:45:00Z - US-006
- **What was implemented:** View Ralph logs command
- **Files changed:**
  - scripts/hive.sh (modified) - Added show_logs_usage(), cmd_logs(), wired up in main router
  - prd.json (updated) - Marked US-006 as passes: true
- **Implementation details:**
  - Command: `hive.sh logs <name> [lines]`
  - Argument parsing handles: name (required), lines (optional, default 50), --follow/-f flag
  - Validates Ralph exists in config.json
  - Checks log file exists at `$worktree_path/ralph-output.log`
  - Shows helpful error messages when Ralph doesn't exist or log file is missing
  - Displays Ralph status context along with log content
  - Uses `tail -n $lines` for default mode, `tail -f` for follow mode
  - Shows tip about `--follow` flag when Ralph is running
  - Visual formatting with CYAN separator lines for log content
- **Learnings for future iterations:**
  - Regex validation for numeric args: `[[ "$1" =~ ^[0-9]+$ ]]`
  - `tail -f` works well for live tailing, exits on Ctrl+C
  - Log file path is stored in config as worktreePath, then append `/ralph-output.log`
---

## [Iteration 7] 2026-01-15T19:00:00Z - US-007
- **What was implemented:** Stop Ralph process command
- **Files changed:**
  - scripts/hive.sh (modified) - Added show_stop_usage(), cmd_stop(), wired up in main router
  - prd.json (updated) - Marked US-007 as passes: true
- **Implementation details:**
  - Command: `hive.sh stop <name>`
  - Validates Ralph exists and checks if it's currently running
  - Handles multiple scenarios:
    - Ralph not running (status != "running"): No-op with info message
    - Running but no PID: Updates status to stopped
    - Running but PID dead: Updates status to stopped
    - Running with live PID: Sends SIGTERM, waits up to 5 seconds, then SIGKILL if needed
  - Updates config.json: sets status to "stopped" and pid to null
  - Preserves worktree and branch for later continuation
  - Provides helpful next steps (restart, status, pr)
- **Learnings for future iterations:**
  - Use `kill -TERM $pid` for graceful shutdown (SIGTERM)
  - Use `kill -KILL $pid` for force kill (SIGKILL)
  - Check process liveness with `kill -0 $pid 2>/dev/null`
  - Use a wait loop with counter for timeout behavior
  - The `|| true` pattern suppresses errors from kill on already-dead processes
---

## [Iteration 8] 2026-01-15T19:15:00Z - US-008
- **What was implemented:** Sync worktree with target branch command
- **Files changed:**
  - scripts/hive.sh (modified) - Added show_sync_usage(), cmd_sync(), wired up in main router
  - prd.json (updated) - Marked US-008 as passes: true
- **Implementation details:**
  - Command: `hive.sh sync <name>`
  - Validates Ralph exists and worktree directory is present
  - Fetches latest changes from origin
  - Handles uncommitted changes by stashing before merge, restoring after
  - Pauses running Ralph processes using SIGSTOP before sync, resumes with SIGCONT after
  - Merges targetBranch (origin/<target>) into Ralph's current branch
  - Comprehensive conflict handling:
    - Detects merge conflicts with `git ls-files --unmerged`
    - Lists conflicting files with helpful formatting
    - Provides step-by-step resolution instructions
    - Provides abort instructions if user wants to cancel merge
  - Updates config.json lastUpdate timestamp after successful sync
  - Handles edge cases: process dies during sync, stash pop fails, fetch fails
- **Learnings for future iterations:**
  - Use `kill -STOP $pid` to pause a process, `kill -CONT $pid` to resume (safer than stopping/restarting)
  - Use `git stash push -m "message"` to create named stashes for easier identification
  - Use `git ls-files --unmerged` to detect merge conflicts
  - Use `cd - > /dev/null` to return to previous directory silently
  - Stash operations in git return non-zero if stash pop has conflicts, handle gracefully
---

## [Iteration 9] 2026-01-15T19:30:00Z - US-009
- **What was implemented:** Create Pull Request from Ralph's branch command
- **Files changed:**
  - scripts/hive.sh (modified) - Added show_pr_usage(), cmd_pr(), wired up in main router
  - prd.json (updated) - Marked US-009 as passes: true
- **Implementation details:**
  - Command: `hive.sh pr <name> [--draft] [--to <target>]`
  - Validates Ralph exists, gh CLI is installed and authenticated
  - Checks for existing PR in config.json to avoid duplicates
  - Warns if multiple Ralphs are attached to the same branch with interactive confirmation
  - Handles uncommitted changes:
    - Commits staged/unstaged changes with descriptive message
    - Adds and commits untracked files separately
  - Pushes branch to origin with -u flag for tracking
  - Generates PR title from branch name (e.g., "feature/auth-system" → "[name] Auth System")
  - Generates PR body with:
    - Summary section with Ralph info
    - Commit count and log summary
    - Files changed stats
    - Hive attribution footer
  - Uses `gh pr create` with --draft flag support
  - Handles case where PR already exists on GitHub (updates config with existing PR info)
  - Stores PR info in config.json: number, url, state, draft, createdAt
  - Updates Ralph status to 'pr_created'
- **Learnings for future iterations:**
  - Use `gh auth status` to check if gh CLI is authenticated
  - Use `git rev-list --count "origin/$target..$branch"` to count commits between branches
  - Use `git diff --stat "origin/$target..$branch"` to get file change summary
  - PR URL is output by `gh pr create` on success, can extract PR number from URL
  - Use `gh pr view $branch --json number,url` to get existing PR info by branch name
---

## [Iteration 10] 2026-01-15T19:45:00Z - US-010
- **What was implemented:** List and check PR status command
- **Files changed:**
  - scripts/hive.sh (modified) - Added show_prs_usage(), cmd_prs(), to_upper() helper, wired up in main router
  - prd.json (updated) - Marked US-010 as passes: true
- **Implementation details:**
  - Command: `hive.sh prs`
  - Lists all Ralphs that have created PRs with color-coded output
  - Shows PR number, URL, state (open/merged/closed), draft indicator
  - Uses `gh pr view` to fetch live status from GitHub when available
  - Gets comprehensive PR info in single API call: state, statusCheckRollup, reviewDecision, mergeable, additions, deletions, changedFiles, isDraft
  - Calculates overall CI check status from statusCheckRollup array (FAILURE > SUCCESS > PENDING)
  - Shows review status (approved/changes_requested/review_required/pending)
  - Shows mergeable status for open PRs (mergeable/conflicting)
  - Shows diff stats (additions, deletions, changed files count)
  - Gracefully handles gh CLI not available or not authenticated (shows cached data only)
  - Summary section shows total counts by state (open/merged/closed) and CI status (passing/failing/pending)
  - Color scheme: green=open/passing/approved, cyan=merged, red=closed/failing/changes_requested, yellow=pending
- **Learnings for future iterations:**
  - Bash 3.2 on macOS doesn't support ${var^^} for uppercase - use `tr '[:lower:]' '[:upper:]'` instead
  - Added to_upper() helper function for bash 3.2 compatibility
  - Use `gh pr view $pr_number --json field1,field2,...` to get multiple fields in one API call
  - statusCheckRollup is an array; need jq logic to derive overall status (any failure = FAILURE, all success = SUCCESS, otherwise PENDING)
  - reviewDecision can be APPROVED, CHANGES_REQUESTED, REVIEW_REQUIRED, or null/empty
  - mergeable can be MERGEABLE, CONFLICTING, or UNKNOWN
---
