# Hive Multi-Agent Docker Compose
# Queen (orchestrator) + Workers (execute tasks)

x-agent-common: &agent-common
  build:
    context: .
    dockerfile: ${HIVE_DOCKERFILE:-docker/Dockerfile.node}
  stdin_open: true
  tty: true
  env_file:
    - .env
    - path: .env.project
      required: false
  group_add:
    - "0"
  environment: &agent-env
    HOME: /home/agent
    # Git config
    GIT_USER_EMAIL: ${GIT_USER_EMAIL:-user@example.com}
    GIT_USER_NAME: ${GIT_USER_NAME:-User Name}
    # Redis connection
    REDIS_HOST: hive-redis
    REDIS_PORT: 6379
    # Docker/Testcontainers
    DOCKER_HOST: unix:///var/run/docker.sock
    TESTCONTAINERS_RYUK_DISABLED: "true"
    # Playwright
    PLAYWRIGHT_BROWSERS_PATH: /opt/playwright
    # Claude permissions bypass
    CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS: "1"
    CLAUDE_CODE_BYPASS_PERMISSIONS_ACCEPTED: "1"
    # Claude auth (choose one)
    CLAUDE_CODE_OAUTH_TOKEN: ${CLAUDE_CODE_OAUTH_TOKEN:-}
    # Optional: GitHub/GitLab tokens
    GITHUB_TOKEN: ${GITHUB_TOKEN:-}
    GITLAB_TOKEN: ${GITLAB_TOKEN:-}
    GITLAB_HOST: ${GITLAB_HOST:-gitlab.com}
    # Workspace config
    WORKSPACE_NAME: ${WORKSPACE_NAME:-my-project}
    # Node.js memory configuration (in MB)
    NODE_OPTIONS: "--max-old-space-size=${NODE_MAX_OLD_SPACE_SIZE:-4096}"

services:
  # =============================================
  # REDIS (Task Queue)
  # =============================================
  redis:
    image: redis:7-alpine
    container_name: hive-redis
    restart: unless-stopped
    ports:
      - "6380:6379"  # Use 6380 on host to avoid conflict
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # =============================================
  # QUEEN - Orchestrator
  # =============================================
  queen:
    <<: *agent-common
    container_name: claude-queen
    working_dir: /workspace/${WORKSPACE_NAME:-my-project}
    volumes:
      - ${HIVE_WORKSPACES:-./workspaces}/queen:/workspace
      # Git repository (for worktree support)
      - ../.git:/workspace-git:ro
      # Hive config
      - ../hive.yaml:/hive-config/hive.yaml:ro
      # SHARED Claude config (MCPs, plugins, projects) - NOT settings.json or skills
      - ${HOME}/.claude/mcps:/home/agent/.claude/mcps:ro
      - ${HOME}/.claude/plugins:/home/agent/.claude/plugins:ro
      - ${HOME}/.claude/projects:/home/agent/.claude/projects
      # ISOLATED conversation history per agent
      - ${HIVE_WORKSPACES:-./workspaces}/queen/history.jsonl:/home/agent/.claude/history.jsonl
      - ${HIVE_WORKSPACES:-./workspaces}/queen/session-env:/home/agent/.claude/session-env
      # SSH & Git
      - ${HOME}/.ssh:/home/agent/.ssh:ro
      - ${HOME}/.gitconfig:/home/agent/.gitconfig:ro
      # Docker socket
      - /var/run/docker.sock:/var/run/docker.sock
      # Tasks & instructions
      - ${HIVE_TASKS:-./tasks}:/hive-tasks
      - ./templates/CLAUDE-QUEEN.md:/home/agent/CLAUDE.md:ro
      # pnpm cache (optional, speeds up installs)
      - pnpm-store:/home/agent/.local/share/pnpm/store
    environment:
      <<: *agent-env
      AGENT_ID: queen
      AGENT_ROLE: orchestrator
      HIVE_TASKS_DIR: /hive-tasks
      CLAUDE_MODEL: ${QUEEN_MODEL:-opus}

  # =============================================
  # WORKERS (agent-1 to agent-10)
  # =============================================
  agent-1:
    <<: *agent-common
    container_name: claude-agent-1
    working_dir: /workspace/${WORKSPACE_NAME:-my-project}
    volumes:
      - ${HIVE_WORKSPACES:-./workspaces}/drone-1:/workspace
      # Git repository (for worktree support)
      - ../.git:/workspace-git:ro
      # Hive config
      - ../hive.yaml:/hive-config/hive.yaml:ro
      # SHARED Claude config (MCPs, plugins, projects) - NOT settings.json or skills
      - ${HOME}/.claude/mcps:/home/agent/.claude/mcps:ro
      - ${HOME}/.claude/plugins:/home/agent/.claude/plugins:ro
      - ${HOME}/.claude/projects:/home/agent/.claude/projects
      # ISOLATED conversation history per agent
      - ${HIVE_WORKSPACES:-./workspaces}/drone-1/history.jsonl:/home/agent/.claude/history.jsonl
      - ${HIVE_WORKSPACES:-./workspaces}/drone-1/session-env:/home/agent/.claude/session-env
      - ${HOME}/.ssh:/home/agent/.ssh:ro
      - ${HOME}/.gitconfig:/home/agent/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HIVE_TASKS:-./tasks}:/hive-tasks
      - ./templates/CLAUDE-WORKER.md:/home/agent/CLAUDE.md:ro
      - pnpm-store:/home/agent/.local/share/pnpm/store
    environment:
      <<: *agent-env
      AGENT_ID: drone-1
      AGENT_ROLE: worker
      HIVE_TASKS_DIR: /hive-tasks
      CLAUDE_MODEL: ${WORKER_MODEL:-sonnet}

  agent-2:
    <<: *agent-common
    container_name: claude-agent-2
    working_dir: /workspace/${WORKSPACE_NAME:-my-project}
    volumes:
      - ${HIVE_WORKSPACES:-./workspaces}/drone-2:/workspace
      # Git repository (for worktree support)
      - ../.git:/workspace-git:ro
      # Hive config
      - ../hive.yaml:/hive-config/hive.yaml:ro
      # SHARED Claude config (MCPs, plugins, projects) - NOT settings.json or skills
      - ${HOME}/.claude/mcps:/home/agent/.claude/mcps:ro
      - ${HOME}/.claude/plugins:/home/agent/.claude/plugins:ro
      - ${HOME}/.claude/projects:/home/agent/.claude/projects
      # ISOLATED conversation history per agent
      - ${HIVE_WORKSPACES:-./workspaces}/drone-2/history.jsonl:/home/agent/.claude/history.jsonl
      - ${HIVE_WORKSPACES:-./workspaces}/drone-2/session-env:/home/agent/.claude/session-env
      - ${HOME}/.ssh:/home/agent/.ssh:ro
      - ${HOME}/.gitconfig:/home/agent/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HIVE_TASKS:-./tasks}:/hive-tasks
      - ./templates/CLAUDE-WORKER.md:/home/agent/CLAUDE.md:ro
      - pnpm-store:/home/agent/.local/share/pnpm/store
    environment:
      <<: *agent-env
      AGENT_ID: drone-2
      AGENT_ROLE: worker
      HIVE_TASKS_DIR: /hive-tasks
      CLAUDE_MODEL: ${WORKER_MODEL:-sonnet}

  agent-3:
    <<: *agent-common
    container_name: claude-agent-3
    working_dir: /workspace/${WORKSPACE_NAME:-my-project}
    volumes:
      - ${HIVE_WORKSPACES:-./workspaces}/drone-3:/workspace
      # Git repository (for worktree support)
      - ../.git:/workspace-git:ro
      # Hive config
      - ../hive.yaml:/hive-config/hive.yaml:ro
      # SHARED Claude config (MCPs, plugins, projects) - NOT settings.json or skills
      - ${HOME}/.claude/mcps:/home/agent/.claude/mcps:ro
      - ${HOME}/.claude/plugins:/home/agent/.claude/plugins:ro
      - ${HOME}/.claude/projects:/home/agent/.claude/projects
      # ISOLATED conversation history per agent
      - ${HIVE_WORKSPACES:-./workspaces}/drone-3/history.jsonl:/home/agent/.claude/history.jsonl
      - ${HIVE_WORKSPACES:-./workspaces}/drone-3/session-env:/home/agent/.claude/session-env
      - ${HOME}/.ssh:/home/agent/.ssh:ro
      - ${HOME}/.gitconfig:/home/agent/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HIVE_TASKS:-./tasks}:/hive-tasks
      - ./templates/CLAUDE-WORKER.md:/home/agent/CLAUDE.md:ro
      - pnpm-store:/home/agent/.local/share/pnpm/store
    environment:
      <<: *agent-env
      AGENT_ID: drone-3
      AGENT_ROLE: worker
      HIVE_TASKS_DIR: /hive-tasks
      CLAUDE_MODEL: ${WORKER_MODEL:-sonnet}

  agent-4:
    <<: *agent-common
    container_name: claude-agent-4
    working_dir: /workspace/${WORKSPACE_NAME:-my-project}
    volumes:
      - ${HIVE_WORKSPACES:-./workspaces}/drone-4:/workspace
      # Git repository (for worktree support)
      - ../.git:/workspace-git:ro
      # Hive config
      - ../hive.yaml:/hive-config/hive.yaml:ro
      # SHARED Claude config (MCPs, plugins, projects) - NOT settings.json or skills
      - ${HOME}/.claude/mcps:/home/agent/.claude/mcps:ro
      - ${HOME}/.claude/plugins:/home/agent/.claude/plugins:ro
      - ${HOME}/.claude/projects:/home/agent/.claude/projects
      # ISOLATED conversation history per agent
      - ${HIVE_WORKSPACES:-./workspaces}/drone-4/history.jsonl:/home/agent/.claude/history.jsonl
      - ${HIVE_WORKSPACES:-./workspaces}/drone-4/session-env:/home/agent/.claude/session-env
      - ${HOME}/.ssh:/home/agent/.ssh:ro
      - ${HOME}/.gitconfig:/home/agent/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HIVE_TASKS:-./tasks}:/hive-tasks
      - ./templates/CLAUDE-WORKER.md:/home/agent/CLAUDE.md:ro
      - pnpm-store:/home/agent/.local/share/pnpm/store
    environment:
      <<: *agent-env
      AGENT_ID: drone-4
      AGENT_ROLE: worker
      HIVE_TASKS_DIR: /hive-tasks
      CLAUDE_MODEL: ${WORKER_MODEL:-sonnet}

  agent-5:
    <<: *agent-common
    container_name: claude-agent-5
    working_dir: /workspace/${WORKSPACE_NAME:-my-project}
    volumes:
      - ${HIVE_WORKSPACES:-./workspaces}/drone-5:/workspace
      # Git repository (for worktree support)
      - ../.git:/workspace-git:ro
      # Hive config
      - ../hive.yaml:/hive-config/hive.yaml:ro
      # SHARED Claude config (MCPs, plugins, projects) - NOT settings.json or skills
      - ${HOME}/.claude/mcps:/home/agent/.claude/mcps:ro
      - ${HOME}/.claude/plugins:/home/agent/.claude/plugins:ro
      - ${HOME}/.claude/projects:/home/agent/.claude/projects
      # ISOLATED conversation history per agent
      - ${HIVE_WORKSPACES:-./workspaces}/drone-5/history.jsonl:/home/agent/.claude/history.jsonl
      - ${HIVE_WORKSPACES:-./workspaces}/drone-5/session-env:/home/agent/.claude/session-env
      - ${HOME}/.ssh:/home/agent/.ssh:ro
      - ${HOME}/.gitconfig:/home/agent/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HIVE_TASKS:-./tasks}:/hive-tasks
      - ./templates/CLAUDE-WORKER.md:/home/agent/CLAUDE.md:ro
      - pnpm-store:/home/agent/.local/share/pnpm/store
    environment:
      <<: *agent-env
      AGENT_ID: drone-5
      AGENT_ROLE: worker
      HIVE_TASKS_DIR: /hive-tasks
      CLAUDE_MODEL: ${WORKER_MODEL:-sonnet}

  agent-6:
    <<: *agent-common
    container_name: claude-agent-6
    working_dir: /workspace/${WORKSPACE_NAME:-my-project}
    volumes:
      - ${HIVE_WORKSPACES:-./workspaces}/drone-6:/workspace
      # Git repository (for worktree support)
      - ../.git:/workspace-git:ro
      # Hive config
      - ../hive.yaml:/hive-config/hive.yaml:ro
      # SHARED Claude config (MCPs, plugins, projects) - NOT settings.json or skills
      - ${HOME}/.claude/mcps:/home/agent/.claude/mcps:ro
      - ${HOME}/.claude/plugins:/home/agent/.claude/plugins:ro
      - ${HOME}/.claude/projects:/home/agent/.claude/projects
      # ISOLATED conversation history per agent
      - ${HIVE_WORKSPACES:-./workspaces}/drone-6/history.jsonl:/home/agent/.claude/history.jsonl
      - ${HIVE_WORKSPACES:-./workspaces}/drone-6/session-env:/home/agent/.claude/session-env
      - ${HOME}/.ssh:/home/agent/.ssh:ro
      - ${HOME}/.gitconfig:/home/agent/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HIVE_TASKS:-./tasks}:/hive-tasks
      - ./templates/CLAUDE-WORKER.md:/home/agent/CLAUDE.md:ro
      - pnpm-store:/home/agent/.local/share/pnpm/store
    environment:
      <<: *agent-env
      AGENT_ID: drone-6
      AGENT_ROLE: worker
      HIVE_TASKS_DIR: /hive-tasks
      CLAUDE_MODEL: ${WORKER_MODEL:-sonnet}

  agent-7:
    <<: *agent-common
    container_name: claude-agent-7
    working_dir: /workspace/${WORKSPACE_NAME:-my-project}
    volumes:
      - ${HIVE_WORKSPACES:-./workspaces}/drone-7:/workspace
      # Git repository (for worktree support)
      - ../.git:/workspace-git:ro
      # Hive config
      - ../hive.yaml:/hive-config/hive.yaml:ro
      # SHARED Claude config (MCPs, plugins, projects) - NOT settings.json or skills
      - ${HOME}/.claude/mcps:/home/agent/.claude/mcps:ro
      - ${HOME}/.claude/plugins:/home/agent/.claude/plugins:ro
      - ${HOME}/.claude/projects:/home/agent/.claude/projects
      # ISOLATED conversation history per agent
      - ${HIVE_WORKSPACES:-./workspaces}/drone-7/history.jsonl:/home/agent/.claude/history.jsonl
      - ${HIVE_WORKSPACES:-./workspaces}/drone-7/session-env:/home/agent/.claude/session-env
      - ${HOME}/.ssh:/home/agent/.ssh:ro
      - ${HOME}/.gitconfig:/home/agent/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HIVE_TASKS:-./tasks}:/hive-tasks
      - ./templates/CLAUDE-WORKER.md:/home/agent/CLAUDE.md:ro
      - pnpm-store:/home/agent/.local/share/pnpm/store
    environment:
      <<: *agent-env
      AGENT_ID: drone-7
      AGENT_ROLE: worker
      HIVE_TASKS_DIR: /hive-tasks
      CLAUDE_MODEL: ${WORKER_MODEL:-sonnet}

  agent-8:
    <<: *agent-common
    container_name: claude-agent-8
    working_dir: /workspace/${WORKSPACE_NAME:-my-project}
    volumes:
      - ${HIVE_WORKSPACES:-./workspaces}/drone-8:/workspace
      # Git repository (for worktree support)
      - ../.git:/workspace-git:ro
      # Hive config
      - ../hive.yaml:/hive-config/hive.yaml:ro
      # SHARED Claude config (MCPs, plugins, projects) - NOT settings.json or skills
      - ${HOME}/.claude/mcps:/home/agent/.claude/mcps:ro
      - ${HOME}/.claude/plugins:/home/agent/.claude/plugins:ro
      - ${HOME}/.claude/projects:/home/agent/.claude/projects
      # ISOLATED conversation history per agent
      - ${HIVE_WORKSPACES:-./workspaces}/drone-8/history.jsonl:/home/agent/.claude/history.jsonl
      - ${HIVE_WORKSPACES:-./workspaces}/drone-8/session-env:/home/agent/.claude/session-env
      - ${HOME}/.ssh:/home/agent/.ssh:ro
      - ${HOME}/.gitconfig:/home/agent/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HIVE_TASKS:-./tasks}:/hive-tasks
      - ./templates/CLAUDE-WORKER.md:/home/agent/CLAUDE.md:ro
      - pnpm-store:/home/agent/.local/share/pnpm/store
    environment:
      <<: *agent-env
      AGENT_ID: drone-8
      AGENT_ROLE: worker
      HIVE_TASKS_DIR: /hive-tasks
      CLAUDE_MODEL: ${WORKER_MODEL:-sonnet}

  agent-9:
    <<: *agent-common
    container_name: claude-agent-9
    working_dir: /workspace/${WORKSPACE_NAME:-my-project}
    volumes:
      - ${HIVE_WORKSPACES:-./workspaces}/drone-9:/workspace
      # Git repository (for worktree support)
      - ../.git:/workspace-git:ro
      # Hive config
      - ../hive.yaml:/hive-config/hive.yaml:ro
      # SHARED Claude config (MCPs, plugins, projects) - NOT settings.json or skills
      - ${HOME}/.claude/mcps:/home/agent/.claude/mcps:ro
      - ${HOME}/.claude/plugins:/home/agent/.claude/plugins:ro
      - ${HOME}/.claude/projects:/home/agent/.claude/projects
      # ISOLATED conversation history per agent
      - ${HIVE_WORKSPACES:-./workspaces}/drone-9/history.jsonl:/home/agent/.claude/history.jsonl
      - ${HIVE_WORKSPACES:-./workspaces}/drone-9/session-env:/home/agent/.claude/session-env
      - ${HOME}/.ssh:/home/agent/.ssh:ro
      - ${HOME}/.gitconfig:/home/agent/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HIVE_TASKS:-./tasks}:/hive-tasks
      - ./templates/CLAUDE-WORKER.md:/home/agent/CLAUDE.md:ro
      - pnpm-store:/home/agent/.local/share/pnpm/store
    environment:
      <<: *agent-env
      AGENT_ID: drone-9
      AGENT_ROLE: worker
      HIVE_TASKS_DIR: /hive-tasks
      CLAUDE_MODEL: ${WORKER_MODEL:-sonnet}

  agent-10:
    <<: *agent-common
    container_name: claude-agent-10
    working_dir: /workspace/${WORKSPACE_NAME:-my-project}
    volumes:
      - ${HIVE_WORKSPACES:-./workspaces}/drone-10:/workspace
      # Git repository (for worktree support)
      - ../.git:/workspace-git:ro
      # Hive config
      - ../hive.yaml:/hive-config/hive.yaml:ro
      # SHARED Claude config (MCPs, plugins, projects) - NOT settings.json or skills
      - ${HOME}/.claude/mcps:/home/agent/.claude/mcps:ro
      - ${HOME}/.claude/plugins:/home/agent/.claude/plugins:ro
      - ${HOME}/.claude/projects:/home/agent/.claude/projects
      # ISOLATED conversation history per agent
      - ${HIVE_WORKSPACES:-./workspaces}/drone-10/history.jsonl:/home/agent/.claude/history.jsonl
      - ${HIVE_WORKSPACES:-./workspaces}/drone-10/session-env:/home/agent/.claude/session-env
      - ${HOME}/.ssh:/home/agent/.ssh:ro
      - ${HOME}/.gitconfig:/home/agent/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HIVE_TASKS:-./tasks}:/hive-tasks
      - ./templates/CLAUDE-WORKER.md:/home/agent/CLAUDE.md:ro
      - pnpm-store:/home/agent/.local/share/pnpm/store
    environment:
      <<: *agent-env
      AGENT_ID: drone-10
      AGENT_ROLE: worker
      HIVE_TASKS_DIR: /hive-tasks
      CLAUDE_MODEL: ${WORKER_MODEL:-sonnet}

volumes:
  redis-data:
  pnpm-store:
